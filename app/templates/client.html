<!-- FINAL CLIENT OTOMATIS MUNCULKAN SUMMARY -->
<html>
<head>
  <title>Realtime Ergonomic Posture Detection</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background-color: #f8fafc;
			margin: 0;
			padding: 20px;
			color: #333;
		}
		h1, h2 {
			color: #2563eb;
		}
		label {
			margin-right: 10px;
		}
		select, button {
			padding: 6px 12px;
			margin-right: 10px;
			border-radius: 5px;
			border: 1px solid #ccc;
			font-size: 14px;
		}
		button {
			background-color: #3b82f6;
			color: white;
			cursor: pointer;
		}
		button:hover {
			background-color: #2563eb;
		}
		#status {
			font-weight: bold;
			color: #10b981;
		}
		.section {
			margin-top: 20px;
			padding: 20px;
			background-color: #ffffff;
			border-radius: 10px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
		}
		.summary-line {
			margin: 5px 0;
			padding: 3px 0;
		}
		.highlight {
			font-weight: bold;
			color: #0f172a;
		}
		pre {
			white-space: pre-wrap;
			word-wrap: break-word;
			background-color: #f1f5f9;
			padding: 15px;
			border-radius: 8px;
			font-size: 14px;
			border-left: 4px solid #3b82f6;
		}
		#video {
			display: block;
			margin: 20px auto;
			border-radius: 10px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			max-width: 100%;
			height: auto;
		}
		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 10px;
			margin-top: 10px;
		}
		.grid-item {
			background-color: #e2e8f0;
			border-radius: 6px;
			padding: 10px;
			text-align: center;
			font-size: 14px;
			position: relative;
		}
		.grid-item.warning {
			background-color: #fde68a;
			border: 2px solid #f59e0b;
		}
		.grid-item.warning::after {
			content: '⚠ Default';
			position: absolute;
			bottom: 6px;
			right: 6px;
			font-size: 12px;
			color: #92400e;
		}
		.grid-container {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
			gap: 12px;
			margin-top: 15px;
		}
		.result-box {
			background-color: #f1f5f9;
			padding: 12px;
			border-radius: 8px;
			border-left: 4px solid #2563eb;
		}
	</style>
</head>
<body>
  <h1>Posture Detection Client</h1>

  <div class="section">
    <label for="cameraSelect">Pilih Kamera:</label>
    <select id="cameraSelect"></select>
    <label for="intervalSelect">Interval (ms):</label>
    <select id="intervalSelect">
      <option value="1000">1 detik</option>
      <option value="3000">3 detik</option>
      <option value="5000" selected>5 detik</option>
      <option value="10000">10 detik</option>
    </select>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
    <p id="status">Status: Disconnected</p>

    <h2>Preview Kamera</h2>
    <video id="video" width="480" height="360" autoplay></video>
  </div>

  <div class="section">
    <h2>SID</h2>
    <div id="resultSID" class="summary-line">Belum ada data...</div>

    <h2>Hasil Deteksi (Realtime):</h2>
    <div id="resultBoxes" class="grid-container"></div>

    <div id="angleGrid" class="grid"></div>

    <h2>Hasil Summary:</h2>
    <pre id="summaryDisplay">Belum ada summary...</pre>
  </div>

  <script>
    let socket = null;
    let captureInterval = null;
    let userSID = null;
    let currentStream = null;

    const cameraSelect = document.getElementById('cameraSelect');
    const video = document.getElementById('video');
    const statusText = document.getElementById('status');
    const resultSID = document.getElementById('resultSID');
    const summaryDisplay = document.getElementById('summaryDisplay');
	const resultBoxes = document.getElementById('resultBoxes');

    // Load camera list and start default camera
    window.addEventListener('load', () => {
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const videoDevices = devices.filter(d => d.kind === 'videoinput');
          videoDevices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `Camera ${cameraSelect.length + 1}`;
            cameraSelect.appendChild(option);
          });

          if (videoDevices.length > 0) {
            cameraSelect.selectedIndex = 0;
            startCamera(videoDevices[0].deviceId);
          }
        });
    });

    cameraSelect.onchange = () => {
      startCamera(cameraSelect.value);
    };

    function startCamera(deviceId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } })
        .then(stream => {
          currentStream = stream;
          video.srcObject = stream;
        });
    }

	function renderAngleGrid(details, flags) {
		const angleGrid = document.getElementById('angleGrid');
		angleGrid.innerHTML = '';

		const angles = [
			'sudut_bahu', 'sudut_leher', 'sudut_lutut',
			'sudut_punggung', 'sudut_siku', 'sudut_pergelangan'
		];

		angles.forEach(key => {
			const div = document.createElement('div');
			div.className = 'grid-item';
			if (flags[key]) div.classList.add('warning');
			div.innerHTML = `<strong>${key.replace('sudut_', '').toUpperCase()}</strong><br>${details[key].toFixed(1)}°`;
			angleGrid.appendChild(div);
		});
    }

	function renderResultBoxes(result) {
		resultBoxes.innerHTML = '';

		const makeBox = (title, content) => {
			const box = document.createElement('div');
			box.className = 'result-box';
			box.innerHTML = `<strong>${title}</strong><br><pre>${content}</pre>`;
			return box;
		};

		resultBoxes.appendChild(makeBox('Feedback', result.feedback));

		const reba = `Upper Arm Score: ${result.reba_upper_arm_score}\nLower Arm Score: ${result.reba_lower_arm_score}\nWrist Score: ${result.reba_wrist_score}\nNeck Score: ${result.reba_neck_score}\nTrunk Score: ${result.reba_trunk_score}\nLeg Score: ${result.reba_leg_score}\nFinal Score: ${result.reba_final_score}`;
		resultBoxes.appendChild(makeBox('REBA', reba));

		const rula = `Upper Arm Score: ${result.rula_upper_arm_score}\nLower Arm Score: ${result.rula_lower_arm_score}\nWrist Score: ${result.rula_wrist_score}\nNeck Score: ${result.rula_neck_score}\nTrunk Score: ${result.rula_trunk_score}\nLeg Score: ${result.rula_leg_score}\nFinal Score: ${result.rula_final_score}`;
		resultBoxes.appendChild(makeBox('RULA', rula));

		const sudut = result.details;
		const angles = `Bahu: ${sudut.sudut_bahu}\nLeher: ${sudut.sudut_leher}\nLutut: ${sudut.sudut_lutut}\nPunggung: ${sudut.sudut_punggung}\nSiku: ${sudut.sudut_siku}\nPergelangan: ${sudut.sudut_pergelangan}`;
		resultBoxes.appendChild(makeBox('Sudut', angles));

		const adj = `Shoulder Raised: ${sudut.adjust_shoulder_raised}\nArm Supported: ${sudut.adjust_arm_supported}\nNeck Twist: ${sudut.adjust_neck_twist}\nTrunk Twist: ${sudut.adjust_trunk_twist}\nWrist Twist: ${sudut.adjust_wrist_twist}\nLegs/Feet Supported: ${sudut.adjust_legs_feet}`;
		resultBoxes.appendChild(makeBox('Adjustment', adj));
    }

    document.getElementById('connectBtn').onclick = () => {
      if (socket && socket.connected) return;

      socket = io();

      socket.on('connect', () => {
        statusText.textContent = "Status: Connected";

        const intervalValue = parseInt(document.getElementById('intervalSelect').value);

        socket.emit('init', { interval: intervalValue });
      });

      socket.on('connected_info', (data) => {
        userSID = data.sid;
        console.log("SID diterima:", userSID);
        resultSID.textContent = `${userSID}`;
      });

      socket.on('control', (data) => {
        if (data.command === 'start_capture') {
          const intervalTime = data.interval;

          if (captureInterval) clearInterval(captureInterval);

          captureInterval = setInterval(() => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataURL = canvas.toDataURL('image/png');
            socket.emit('frame', { image: dataURL });
          }, intervalTime);
        }
      });

		socket.on('processed_result', (data) => {
			const result = data.result;
			renderAngleGrid(result.details, result.default_value_flags);
			renderResultBoxes(result);
		});

		function renderSummaryToText(s) {
			return (
				`Summary dari ${s.total_frames} frame:\n\n` +

				`Feedback Umum:\n${s.most_common_feedback}\n\n` +

				`Rangkuman Analisis:\n${s.summary}\n` +

				`Rata-rata Skor REBA:\n` +
				`  Final:        ${s.average_scores.reba_final_score}\n` +
				`  Upper Arm:    ${s.average_scores.reba_upper_arm_score}\n` +
				`  Lower Arm:    ${s.average_scores.reba_lower_arm_score}\n` +
				`  Wrist:        ${s.average_scores.reba_wrist_score}\n` +
				`  Neck:         ${s.average_scores.reba_neck_score}\n` +
				`  Trunk:        ${s.average_scores.reba_trunk_score}\n` +
				`  Legs:         ${s.average_scores.reba_leg_score}\n\n` +

				`Rata-rata Skor RULA:\n` +
				`  Final:        ${s.average_scores.rula_final_score}\n` +
				`  Upper Arm:    ${s.average_scores.rula_upper_arm_score}\n` +
				`  Lower Arm:    ${s.average_scores.rula_lower_arm_score}\n` +
				`  Wrist:        ${s.average_scores.rula_wrist_score}\n` +
				`  Neck:         ${s.average_scores.rula_neck_score}\n` +
				`  Trunk:        ${s.average_scores.rula_trunk_score}\n` +
				`  Legs:         ${s.average_scores.rula_leg_score}\n\n` +

				`Rata-rata Sudut Tubuh:\n` +
				`  Bahu:         ${s.average_sudut.sudut_bahu}°\n` +
				`  Siku:         ${s.average_sudut.sudut_siku}°\n` +
				`  Leher:        ${s.average_sudut.sudut_leher}°\n` +
				`  Lutut:        ${s.average_sudut.sudut_lutut}°\n` +
				`  Punggung:     ${s.average_sudut.sudut_punggung}°\n` +
				`  Pergelangan:  ${s.average_sudut.sudut_pergelangan}°\n\n` +

				`Ringkasan REBA: ${s.reba_summary}\n` +
				`Ringkasan RULA: ${s.rula_summary}`
			);
		}

        socket.on('disconnect', () => {
        statusText.textContent = "Status: Disconnected";
        if (captureInterval) clearInterval(captureInterval);

        setTimeout(() => {
            fetch(`/websocket/summary?sid=${userSID}`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.error) {
                    summaryDisplay.textContent = `Error: ${data.error}`;
                } else {
                    summaryDisplay.textContent = renderSummaryToText(data);
                }
            });
        }, 3000);
        });
    };

    document.getElementById('disconnectBtn').onclick = () => {
      if (socket && socket.connected) {
        socket.disconnect();
      }
    };
  </script>
</body>
</html>