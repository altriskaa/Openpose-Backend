<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Postur Detection Upload</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 20px;
      background: #f4f6f8; color: #333;
    }
    h1 {
      color: #2563eb;
      margin-bottom: 20px;
    }
    .main {
      display: flex; gap: 20px;
    }
    .panel {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      flex: 1;
    }
    .left { max-width: 400px; }
    .drop-zone {
      border: 2px dashed #2563eb;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #2563eb;
      cursor: pointer;
      min-height: 200px;
      position: relative;
    }
    .drop-zone.hover { background: #e0f0ff; }
    .drop-zone img,
    .drop-zone video {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 6px;
      box-shadow: 0 0 0 2px #e0e7ff inset;
    }
    .result img {
      max-width: 100%;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .section-title {
      color: #1e40af;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    .box {
      background: #f1f5f9;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      box-shadow: inset 0 0 0 2px #2563eb;
    }
    .box .label {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 4px;
    }
    .box .value {
      font-size: 20px; color: #0f172a;
    }
    .feedback {
      background: #f1f5f9;
      padding: 15px;
      border-radius: 6px;
      box-shadow: inset 0 0 0 2px #2563eb;
      margin-top: 15px;
      white-space: pre-wrap;
    }
    .center-message {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      min-height: 300px;
      text-align: center;
      font-size: 16px;
      color: #1e293b;
    }
    #intervalSelect {
      display: block;
      margin-top: 16px;
      padding: 10px 14px;
      width: 100%;
      font-size: 14px;
      font-weight: 500;
      color: #1e3a8a;
      background-color: #ffffff;
      border: 2px solid #2563eb;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%232563eb" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      cursor: pointer;
    }

    #intervalSelect option {
      font-size: 14px;
      font-weight: 400;
      color: #0f172a;
      background-color: #ffffff;
      padding: 8px 12px;
    }

    #intervalSelect::-webkit-scrollbar {
      width: 8px;
    }

    #intervalSelect::-webkit-scrollbar-thumb {
      background-color: #2563eb;
      border-radius: 4px;
    }

    #intervalSelect::-webkit-scrollbar-track {
      background-color: #f1f5f9;
    }
  </style>
</head>
<body>
  <h1>Upload Gambar/Video untuk Analisis Postur</h1>

  <div class="main">
    <!-- KIRI: Upload + Preview -->
    <div class="panel left">
      <div id="dropZone" class="drop-zone">
        Klik atau seret file ke sini
      </div>
      <input type="file" id="fileInput" accept="image/*,video/*" style="display:none">
      <select id="intervalSelect" style="display:none; margin-top: 10px;">
        <option value="" disabled selected>Pilih Interval (detik)</option>
        <option value="30">30</option>
        <option value="60">60</option>
        <option value="120">120</option>
        <option value="300">300</option>
      </select>
    </div>

    <!-- KANAN: Hasil -->
    <div class="panel result" id="resultDisplay">
      <!-- konten hasil akan muncul di sini -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const drop = document.getElementById('dropZone'),
          fileIn = document.getElementById('fileInput'),
          result = document.getElementById('resultDisplay');
    let curr;

    drop.addEventListener('click', () => fileIn.click());
    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('hover'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('hover'));
    drop.addEventListener('drop', e => {
      e.preventDefault(); drop.classList.remove('hover');
      if (e.dataTransfer.files[0]) selectFile(e.dataTransfer.files[0]);
    });
    fileIn.addEventListener('change', () => selectFile(fileIn.files[0]));

    function copySwalTextById(elementId, label = "Teks") {
      const text = document.getElementById(elementId)?.innerText || '';
      if (!text) return;

      navigator.clipboard.writeText(text).then(() => {
        Swal.fire({
          title: `${label} disalin!`,
          toast: true,
          position: 'top-end',
          icon: 'success',
          showConfirmButton: false,
          timer: 1500,
          timerProgressBar: true,
          background: '#1f2937',
          color: '#ffffff',
        });
      });
    }

    function selectFile(file) {
      curr = file;
      const type = file.type.startsWith('image/') ? 'image' : 'video';
      drop.innerHTML = '';
      const reader = new FileReader();

      reader.onload = () => {
        const el = type === 'image' ? document.createElement('img') : document.createElement('video');
        el.src = reader.result;
        if (type === 'video') el.controls = true;
        drop.appendChild(el);

        const intervalSelect = document.getElementById('intervalSelect');
        
        if (type === 'video') {
          intervalSelect.style.display = 'block';
          intervalSelect.onchange = () => {
            intervalSelect.style.display = 'none'; // hide again after selection
            callAPI(type, intervalSelect.value);
            intervalSelect.value = ""; // reset after submit
          };
        } else {
          intervalSelect.style.display = 'none';
          callAPI(type);
        }
      };

      reader.readAsDataURL(file);
    }

    async function callAPI(type, interval = null) {
      result.innerHTML = `<div class="center-message">Menganalisis... mohon tunggu.</div>`;
      const fd = new FormData();
      fd.append(type, curr);
      if (interval) fd.append('interval', interval);
      try {
        const res = await fetch(`https://vps.danar.site/model1/predict/${type}`, {
          method: 'POST', body: fd
        });
        const data = await res.json();
        if (type === 'image') renderImage(data.result);
        else pollVideo(data.job_id);
      } catch {
        result.innerHTML = `<div class="center-message" style="color:red;">Error saat upload.</div>`;
      }
    }

    async function pollVideo(jobId) {
      result.innerHTML = `<div class="center-message">Menunggu hasil video dengan Job ID: ${jobId}</div>`;
      const intv = setInterval(async ()=>{
        const r = await fetch(`https://vps.danar.site/model1/predict/video/result?job_id=${jobId}`);
        const j = await r.json();
        if (j.status === 'done') {
          clearInterval(intv);
          j.result.job_id = jobId; 
          renderVideo(j.result);
        }
      }, 2000);
    }

    function renderImage(r) {
      result.innerHTML = '';

      const img = document.createElement('img');
      img.src = r.gambar_path;
      result.appendChild(img);

      result.append(infoSection(r, false));
    }

    function renderVideo(r) {
      result.innerHTML = '';

      const img = document.createElement('img');
      img.src = r.representative_image;
      result.appendChild(img);

      result.append(infoSection(r, true));
    }

    function renderAdjustments(details) {
      const adjDiv = document.createElement('div');
      adjDiv.innerHTML = `<div class="section-title">Adjustment Faktor:</div>`;
      const gd = document.createElement('div'); gd.className = 'grid';

      const adjKeys = {
        adjust_arm_supported: 'Arm Supported',
        adjust_legs_feet: 'Legs/Feet',
        adjust_neck_twist: 'Neck Twist',
        adjust_shoulder_raised: 'Shoulder Raised',
        adjust_trunk_twist: 'Trunk Twist',
        adjust_wrist_twist: 'Wrist Twist'
      };

      Object.keys(adjKeys).forEach(k => {
        const v = details[k];
        const box = document.createElement('div'); box.className = 'box';
        const label = adjKeys[k];
        const val = (v === -1) ? 'Ya' : (v === 0 ? 'Tidak' : 'Ya'); 
        box.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
        gd.appendChild(box);
      });

      adjDiv.appendChild(gd);
      return adjDiv;
    }

    function renderScoreGroup(title, scores, prefix) {
      const div = document.createElement('div');
      div.innerHTML = `<div class="section-title">${title}</div>`;
      const gd = document.createElement('div');
      gd.className = 'grid';

      const keys = ['upper_arm', 'lower_arm', 'wrist', 'neck', 'trunk', 'leg', 'final'];
      keys.forEach(k => {
        const label = k.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        const val = scores[`${prefix}_${k}_score`]?.toFixed(1) ?? '-';
        const box = document.createElement('div'); box.className = 'box';
        box.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
        gd.appendChild(box);
      });

      div.appendChild(gd);
      return div;
    }

    function renderSummaryToText(s) {
			return (
				`Summary dari ${s.total_frames} frame:\n\n` +

				`Feedback Umum:\n${s.most_common_feedback}\n\n` +

				`Rangkuman Analisis:\n${s.summary}\n` +

				`===== RULA =====\n` +

				`Rata-rata Skor RULA:\n` +
				`  Final:        ${s.average_scores.rula_final_score}\n` +
				`  Upper Arm:    ${s.average_scores.rula_upper_arm_score}\n` +
				`  Lower Arm:    ${s.average_scores.rula_lower_arm_score}\n` +
				`  Wrist:        ${s.average_scores.rula_wrist_score}\n` +
				`  Neck:         ${s.average_scores.rula_neck_score}\n` +
				`  Trunk:        ${s.average_scores.rula_trunk_score}\n` +
				`  Legs:         ${s.average_scores.rula_leg_score}\n\n` +

				`Skor Mayoritas RULA:\n` +
				`  Final:        ${s.majority_scores.rula_final_score}\n` +
				`  Upper Arm:    ${s.majority_scores.rula_upper_arm_score}\n` +
				`  Lower Arm:    ${s.majority_scores.rula_lower_arm_score}\n` +
				`  Wrist:        ${s.majority_scores.rula_wrist_score}\n` +
				`  Neck:         ${s.majority_scores.rula_neck_score}\n` +
				`  Trunk:        ${s.majority_scores.rula_trunk_score}\n` +
				`  Legs:         ${s.majority_scores.rula_leg_score}\n\n` +

				`Skor Maksimum RULA:\n` +
				`  Final:        ${s.max_scores.rula_final_score}\n` +
				`  Upper Arm:    ${s.max_scores.rula_upper_arm_score}\n` +
				`  Lower Arm:    ${s.max_scores.rula_lower_arm_score}\n` +
				`  Wrist:        ${s.max_scores.rula_wrist_score}\n` +
				`  Neck:         ${s.max_scores.rula_neck_score}\n` +
				`  Trunk:        ${s.max_scores.rula_trunk_score}\n` +
				`  Legs:         ${s.max_scores.rula_leg_score}\n\n` +

				`Skor Minimum RULA:\n` +
				`  Final:        ${s.min_scores.rula_final_score}\n` +
				`  Upper Arm:    ${s.min_scores.rula_upper_arm_score}\n` +
				`  Lower Arm:    ${s.min_scores.rula_lower_arm_score}\n` +
				`  Wrist:        ${s.min_scores.rula_wrist_score}\n` +
				`  Neck:         ${s.min_scores.rula_neck_score}\n` +
				`  Trunk:        ${s.min_scores.rula_trunk_score}\n` +
				`  Legs:         ${s.min_scores.rula_leg_score}\n\n` +

				`===== REBA =====\n` +

				`Rata-rata Skor REBA:\n` +
				`  Final:        ${s.average_scores.reba_final_score}\n` +
				`  Upper Arm:    ${s.average_scores.reba_upper_arm_score}\n` +
				`  Lower Arm:    ${s.average_scores.reba_lower_arm_score}\n` +
				`  Wrist:        ${s.average_scores.reba_wrist_score}\n` +
				`  Neck:         ${s.average_scores.reba_neck_score}\n` +
				`  Trunk:        ${s.average_scores.reba_trunk_score}\n` +
				`  Legs:         ${s.average_scores.reba_leg_score}\n\n` +

				`Skor Mayoritas REBA:\n` +
				`  Final:        ${s.majority_scores.reba_final_score}\n` +
				`  Upper Arm:    ${s.majority_scores.reba_upper_arm_score}\n` +
				`  Lower Arm:    ${s.majority_scores.reba_lower_arm_score}\n` +
				`  Wrist:        ${s.majority_scores.reba_wrist_score}\n` +
				`  Neck:         ${s.majority_scores.reba_neck_score}\n` +
				`  Trunk:        ${s.majority_scores.reba_trunk_score}\n` +
				`  Legs:         ${s.majority_scores.reba_leg_score}\n\n` +

				`Skor Maksimum REBA:\n` +
				`  Final:        ${s.max_scores.reba_final_score}\n` +
				`  Upper Arm:    ${s.max_scores.reba_upper_arm_score}\n` +
				`  Lower Arm:    ${s.max_scores.reba_lower_arm_score}\n` +
				`  Wrist:        ${s.max_scores.reba_wrist_score}\n` +
				`  Neck:         ${s.max_scores.reba_neck_score}\n` +
				`  Trunk:        ${s.max_scores.reba_trunk_score}\n` +
				`  Legs:         ${s.max_scores.reba_leg_score}\n\n` +

				`Skor Minimum REBA:\n` +
				`  Final:        ${s.min_scores.reba_final_score}\n` +
				`  Upper Arm:    ${s.min_scores.reba_upper_arm_score}\n` +
				`  Lower Arm:    ${s.min_scores.reba_lower_arm_score}\n` +
				`  Wrist:        ${s.min_scores.reba_wrist_score}\n` +
				`  Neck:         ${s.min_scores.reba_neck_score}\n` +
				`  Trunk:        ${s.min_scores.reba_trunk_score}\n` +
				`  Legs:         ${s.min_scores.reba_leg_score}\n\n` +

				`===== Sudut =====\n` +

				`Rata-rata Sudut Tubuh:\n` +
				`  Bahu:         ${s.average_sudut.sudut_bahu}°\n` +
				`  Siku:         ${s.average_sudut.sudut_siku}°\n` +
				`  Leher:        ${s.average_sudut.sudut_leher}°\n` +
				`  Lutut:        ${s.average_sudut.sudut_lutut}°\n` +
				`  Punggung:     ${s.average_sudut.sudut_punggung}°\n` +
				`  Pergelangan:  ${s.average_sudut.sudut_pergelangan}°\n\n` +

				`===== Ringkasan =====\n` +

				`Ringkasan RULA: ${s.rula_summary}\n` +
				`Ringkasan REBA: ${s.reba_summary}`
			);
		}

    function infoSection(r, isVideo) {
      const frag = document.createDocumentFragment();
      if (isVideo && r.job_id) {
        const sectionContainer = document.createElement('div');
        sectionContainer.style.display = 'flex';
        sectionContainer.style.alignItems = 'center';
        sectionContainer.style.gap = '8px'; // Jarak antara teks dan tombol

        const job_value = document.createElement('div');
        job_value.className = 'section-title';
        job_value.textContent = 'Job ID';

        const copyButton = document.createElement('button');
        copyButton.title = 'Salin Feedback';
        copyButton.onclick = () => copySwalTextById(`jobId_${r.job_id}`);
        copyButton.style.background = 'none';
        copyButton.style.border = 'none';
        copyButton.style.cursor = 'pointer';

        copyButton.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" height="20" fill="#2563eb" viewBox="0 0 24 24">
            <path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v16h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 18H8V7h11v16Z"/>
          </svg>
        `;

        // Masukkan teks dan tombol ke dalam sectionContainer
        sectionContainer.appendChild(job_value);
        sectionContainer.appendChild(copyButton);

        // Tambahkan ke DOM
        frag.appendChild(sectionContainer);

        const jobDiv = document.createElement('div');
        jobDiv.className = 'feedback';
        jobDiv.id = `jobId_${r.job_id}`; // tambahkan id untuk bisa disalin
        jobDiv.textContent = `${r.job_id}`;
        frag.appendChild(jobDiv);
      }

      // Buat container untuk judul dan tombol copy
      const feedbackHeaderContainer = document.createElement('div');
      feedbackHeaderContainer.style.display = 'flex';
      feedbackHeaderContainer.style.alignItems = 'center';
      feedbackHeaderContainer.style.gap = '8px';

      const feedbackTitle = document.createElement('div');
      feedbackTitle.className = 'section-title';
      feedbackTitle.textContent = 'Feedback Deteksi Postur';

      // Buat tombol copy
      const copyFeedbackButton = document.createElement('button');
      copyFeedbackButton.title = 'Salin Feedback';
      copyFeedbackButton.style.background = 'none';
      copyFeedbackButton.style.border = 'none';
      copyFeedbackButton.style.cursor = 'pointer';
      copyFeedbackButton.onclick = () => copySwalTextById('feedbackText');

      copyFeedbackButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" height="20" fill="#2563eb" viewBox="0 0 24 24">
          <path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v16h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 18H8V7h11v16Z"/>
        </svg>
      `;

      // Tambahkan title dan tombol ke container
      feedbackHeaderContainer.appendChild(feedbackTitle);
      feedbackHeaderContainer.appendChild(copyFeedbackButton);

      // Masukkan ke dalam frag
      frag.appendChild(feedbackHeaderContainer);

      // Buat elemen feedback yang bisa disalin
      const hdrFeedback = document.createElement('div');
      hdrFeedback.className = 'feedback';
      hdrFeedback.id = 'feedbackText'; // ID ini digunakan oleh fungsi salin
      hdrFeedback.textContent = isVideo ? r.most_common_feedback : r.feedback;
      frag.appendChild(hdrFeedback);

      const reba = SectionGrid('REBA', isVideo ? r.average_scores : r, isVideo);
      const rula = SectionGrid('RULA', isVideo ? r.average_scores : r, isVideo);
      frag.appendChild(reba);
      frag.appendChild(rula);

      // Sudut details
      const sud = isVideo ? r.average_sudut : r.details;
      const sudDiv = document.createElement('div');
      sudDiv.innerHTML = isVideo ? `<div class="section-title">Rata-Rata Sudut Tubuh:</div>` : `<div class="section-title">Sudut Tubuh:</div>`;
      const gd = document.createElement('div'); gd.className = 'grid';
      ['bahu','leher','lutut','punggung','siku','pergelangan'].forEach(k=>{
        const kb = k.charAt(0).toUpperCase()+k.slice(1);
        const vb = sud[`sudut_${k}`].toFixed(1)+'°';
        const box = document.createElement('div'); box.className='box';
        box.innerHTML = `<div class="label">${kb}</div><div class="value">${vb}</div>`;
        gd.appendChild(box);
      });
      sudDiv.appendChild(gd);
      frag.appendChild(sudDiv);

      if (!isVideo && r.details) {
        frag.appendChild(renderAdjustments(r.details));
      }

      if (isVideo) {
        frag.appendChild(renderScoreGroup('Mayoritas Skor REBA', r.majority_scores, 'reba'));
        frag.appendChild(renderScoreGroup('Mayoritas Skor RULA', r.majority_scores, 'rula'));
        frag.appendChild(renderScoreGroup('Skor Maksimum REBA', r.max_scores, 'reba'));
        frag.appendChild(renderScoreGroup('Skor Maksimum RULA', r.max_scores, 'rula'));
        frag.appendChild(renderScoreGroup('Skor Minimum REBA', r.min_scores, 'reba'));
        frag.appendChild(renderScoreGroup('Skor Minimum RULA', r.min_scores, 'rula'));
      }

      // Buat container judul dan tombol copy
      const feedbackRulaRebaHeader = document.createElement('div');
      feedbackRulaRebaHeader.style.display = 'flex';
      feedbackRulaRebaHeader.style.alignItems = 'center';
      feedbackRulaRebaHeader.style.gap = '8px';

      const feedback_rula_rebaTitle = document.createElement('div');
      feedback_rula_rebaTitle.className = 'section-title';
      feedback_rula_rebaTitle.textContent = 'Feedback Rula & Reba';

      // Buat tombol copy
      const copyRulaRebaButton = document.createElement('button');
      copyRulaRebaButton.title = 'Salin Rula & Reba';
      copyRulaRebaButton.style.background = 'none';
      copyRulaRebaButton.style.border = 'none';
      copyRulaRebaButton.style.cursor = 'pointer';
      copyRulaRebaButton.onclick = () => copySwalTextById('rulaRebaText');

      copyRulaRebaButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" height="20" fill="#2563eb" viewBox="0 0 24 24">
          <path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v16h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 18H8V7h11v16Z"/>
        </svg>
      `;

      // Gabungkan judul dan tombol ke container
      feedbackRulaRebaHeader.appendChild(feedback_rula_rebaTitle);
      feedbackRulaRebaHeader.appendChild(copyRulaRebaButton);

      // Masukkan ke frag
      frag.appendChild(feedbackRulaRebaHeader);

      // Buat elemen feedback
      const sum = isVideo ? renderSummaryToText(r) : `REBA: ${r.summary.reba_summary}\nRULA: ${r.summary.rula_summary}`;
      const sb = document.createElement('div');
      sb.className = 'feedback';
      sb.id = 'rulaRebaText'; // ID yang dipakai buat salin teks
      sb.textContent = sum;
      frag.appendChild(sb);

      return frag;
    }

    function SectionGrid(title, data, isVideo) {
      const cont = document.createDocumentFragment();
      const div = document.createElement('div');
      div.innerHTML = isVideo ? `<div class="section-title">Rata-Rata ${title}</div>` : `<div class="section-title">${title}</div>`;
      const gd = document.createElement('div'); gd.className = 'grid';
      const keys = ['upper_arm','lower_arm','wrist','neck','trunk','leg','final'];
      keys.forEach(k=>{
        const label = k.split('_').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
        const val = data[`${title.toLowerCase()}_${k}_score`].toFixed(1);
        const box = document.createElement('div'); box.className='box';
        box.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
        gd.appendChild(box);
      });
      div.appendChild(gd);
      return div;
    }

  </script>
</body>
</html>
