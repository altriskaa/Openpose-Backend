<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Postur Detection Upload</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 20px;
      background: #f4f6f8; color: #333;
    }
    h1 {
      color: #2563eb;
      margin-bottom: 20px;
    }
    .main {
      display: flex; gap: 20px;
    }
    .panel {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      flex: 1;
    }
    .left { max-width: 400px; }
    .drop-zone {
      border: 2px dashed #2563eb;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #2563eb;
      cursor: pointer;
      min-height: 200px;
      position: relative;
    }
    .drop-zone.hover { background: #e0f0ff; }
    .drop-zone img,
    .drop-zone video {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 6px;
      box-shadow: 0 0 0 2px #e0e7ff inset;
    }
    .result img {
      max-width: 100%;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .section-title {
      color: #1e40af;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    .box {
      background: #f1f5f9;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      box-shadow: inset 0 0 0 2px #2563eb;
    }
    .box .label {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 4px;
    }
    .box .value {
      font-size: 20px; color: #0f172a;
    }
    .feedback {
      background: #f1f5f9;
      padding: 15px;
      border-radius: 6px;
      box-shadow: inset 0 0 0 2px #2563eb;
      margin-top: 15px;
      white-space: pre-wrap;
    }
    .center-message {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      min-height: 300px;
      text-align: center;
      font-size: 16px;
      color: #1e293b;
    }
  </style>
</head>
<body>
  <h1>Upload Gambar/Video untuk Analisis Postur</h1>

  <div class="main">
    <!-- KIRI: Upload + Preview -->
    <div class="panel left">
      <div id="dropZone" class="drop-zone">
        Klik atau seret file ke sini
      </div>
      <input type="file" id="fileInput" accept="image/*,video/*" style="display:none">
    </div>

    <!-- KANAN: Hasil -->
    <div class="panel result" id="resultDisplay">
      <!-- konten hasil akan muncul di sini -->
    </div>
  </div>

  <script>
    const drop = document.getElementById('dropZone'),
          fileIn = document.getElementById('fileInput'),
          result = document.getElementById('resultDisplay');
    let curr;

    drop.addEventListener('click', () => fileIn.click());
    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('hover'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('hover'));
    drop.addEventListener('drop', e => {
      e.preventDefault(); drop.classList.remove('hover');
      if (e.dataTransfer.files[0]) selectFile(e.dataTransfer.files[0]);
    });
    fileIn.addEventListener('change', () => selectFile(fileIn.files[0]));

    function selectFile(file) {
      curr = file;
      const type = file.type.startsWith('image/') ? 'image' : 'video';
      drop.innerHTML = '';
      const reader = new FileReader();
      reader.onload = () => {
        const el = type === 'image' ? document.createElement('img') : document.createElement('video');
        el.src = reader.result;
        if (type === 'video') el.controls = true;
        drop.appendChild(el);
        callAPI(type);
      };
      reader.readAsDataURL(file);
    }

    async function callAPI(type) {
      result.innerHTML = `<div class="center-message">Menganalisis... mohon tunggu.</div>`;
      const fd = new FormData();
      fd.append(type, curr);
      try {
        const res = await fetch(`https://vps.danar.site/model1/predict/${type}`, {
          method: 'POST', body: fd
        });
        const data = await res.json();
        if (type === 'image') renderImage(data.result);
        else pollVideo(data.job_id);
      } catch {
        result.innerHTML = `<div class="center-message" style="color:red;">Error saat upload.</div>`;
      }
    }

    async function pollVideo(jobId) {
      result.innerHTML = `<p>Menunggu hasil video...</p>`;
      const intv = setInterval(async ()=>{
        const r = await fetch(`https://vps.danar.site/model1/predict/video/result?job_id=${jobId}`);
        const j = await r.json();
        if (j.status === 'done') {
          clearInterval(intv);
          renderVideo(j.result);
        }
      }, 2000);
    }

    function renderImage(r) {
      result.innerHTML = '';

      const img = document.createElement('img');
      img.src = r.gambar_path;
      result.appendChild(img);

      result.append(infoSection(r, false));
    }

    function renderVideo(r) {
      result.innerHTML = '';

      const img = document.createElement('img');
      img.src = r.representative_image;
      result.appendChild(img);

      result.append(infoSection(r, true));
    }

    function renderAdjustments(details) {
      const adjDiv = document.createElement('div');
      adjDiv.innerHTML = `<div class="section-title">Adjustment Faktor:</div>`;
      const gd = document.createElement('div'); gd.className = 'grid';

      const adjKeys = {
        adjust_arm_supported: 'Arm Supported',
        adjust_legs_feet: 'Legs/Feet',
        adjust_neck_twist: 'Neck Twist',
        adjust_shoulder_raised: 'Shoulder Raised',
        adjust_trunk_twist: 'Trunk Twist',
        adjust_wrist_twist: 'Wrist Twist'
      };

      Object.keys(adjKeys).forEach(k => {
        const v = details[k];
        const box = document.createElement('div'); box.className = 'box';
        const label = adjKeys[k];
        const val = (v === -1) ? 'Ya' : (v === 0 ? 'Tidak' : 'Ya'); 
        box.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
        gd.appendChild(box);
      });

      adjDiv.appendChild(gd);
      return adjDiv;
    }

    function infoSection(r, isVideo) {
      const frag = document.createDocumentFragment();

      const feedbackTitle = document.createElement('div');
      feedbackTitle.className = 'section-title';
      feedbackTitle.textContent = 'Feedback Deteksi Postur';
      frag.appendChild(feedbackTitle);

      const hdrFeedback = document.createElement('div');
      hdrFeedback.className = 'feedback';
      hdrFeedback.textContent = isVideo ? r.most_common_feedback : r.feedback;
      frag.appendChild(hdrFeedback);

      const reba = SectionGrid('REBA', isVideo ? r.average_scores : r);
      const rula = SectionGrid('RULA', isVideo ? r.average_scores : r);
      frag.appendChild(reba);
      frag.appendChild(rula);

      // Sudut details
      const sud = isVideo ? r.average_sudut : r.details;
      const sudDiv = document.createElement('div');
      sudDiv.innerHTML = isVideo ? `<div class="section-title">Rata-Rata Sudut Tubuh:</div>` : `<div class="section-title">Sudut Tubuh:</div>`;
      const gd = document.createElement('div'); gd.className = 'grid';
      ['bahu','leher','lutut','punggung','siku','pergelangan'].forEach(k=>{
        const kb = k.charAt(0).toUpperCase()+k.slice(1);
        const vb = sud[`sudut_${k}`].toFixed(1)+'Â°';
        const box = document.createElement('div'); box.className='box';
        box.innerHTML = `<div class="label">${kb}</div><div class="value">${vb}</div>`;
        gd.appendChild(box);
      });
      sudDiv.appendChild(gd);
      frag.appendChild(sudDiv);

      if (!isVideo && r.details) {
        frag.appendChild(renderAdjustments(r.details));
      }

      const feedback_rula_rebaTitle = document.createElement('div');
      feedback_rula_rebaTitle.className = 'section-title';
      feedback_rula_rebaTitle.textContent = 'Feedback Rula & Reba';
      frag.appendChild(feedback_rula_rebaTitle);
      // Summary teks
      const sum = isVideo ? r.summary : `REBA: ${r.summary.reba_summary}\nRULA: ${r.summary.rula_summary}`;
      const sb = document.createElement('div');
      sb.className = 'feedback';
      sb.textContent = sum;
      frag.appendChild(sb);

      return frag;
    }

    function SectionGrid(title, data) {
      const cont = document.createDocumentFragment();
      const div = document.createElement('div');
      div.innerHTML = `<div class="section-title">${title}</div>`;
      const gd = document.createElement('div'); gd.className = 'grid';
      const keys = ['upper_arm','lower_arm','wrist','neck','trunk','leg','final'];
      keys.forEach(k=>{
        const label = k.split('_').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
        const val = data[`${title.toLowerCase()}_${k}_score`].toFixed(1);
        const box = document.createElement('div'); box.className='box';
        box.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
        gd.appendChild(box);
      });
      div.appendChild(gd);
      return div;
    }

  </script>
</body>
</html>
